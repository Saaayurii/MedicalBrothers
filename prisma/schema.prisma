// Prisma schema for Medical Voice Assistant

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Doctors table
model Doctor {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(255)
  specialty       String    @db.VarChar(100)
  experienceYears Int?      @map("experience_years")
  bio             String?   @db.Text
  photoUrl        String?   @map("photo_url") @db.VarChar(500)
  phone           String?   @db.VarChar(20)
  email           String?   @db.VarChar(255)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  schedules      DoctorSchedule[]
  timeSlots      TimeSlot[]
  appointments   Appointment[]
  reviews        Review[]
  medicalRecords MedicalRecord[]
  labOrders      LabOrder[]

  @@index([specialty])
  @@index([isActive])
  @@index([email])
  @@map("doctors")
}

// Doctor schedules
model DoctorSchedule {
  id          Int      @id @default(autoincrement())
  doctorId    Int      @map("doctor_id")
  dayOfWeek   Int      @map("day_of_week") // 0 = Sunday, 1 = Monday, etc.
  startTime   DateTime @map("start_time") @db.Time(6)
  endTime     DateTime @map("end_time") @db.Time(6)
  isAvailable Boolean  @default(true) @map("is_available")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([dayOfWeek])
  @@index([isAvailable])
  @@map("doctor_schedules")
}

// Time slots for appointments
model TimeSlot {
  id              Int      @id @default(autoincrement())
  doctorId        Int      @map("doctor_id")
  slotDate        DateTime @map("slot_date") @db.Date
  slotTime        DateTime @map("slot_time") @db.Time(6)
  isBooked        Boolean  @default(false) @map("is_booked")
  durationMinutes Int      @default(30) @map("duration_minutes")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  doctor       Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@unique([doctorId, slotDate, slotTime])
  @@index([doctorId])
  @@index([slotDate])
  @@index([isBooked])
  @@index([doctorId, slotDate, isBooked])
  @@map("time_slots")
}

// Patients table
model Patient {
  id             Int      @id @default(autoincrement())
  name           String?  @db.VarChar(255)
  phone          String?  @unique @db.VarChar(20)
  email          String?  @unique @db.VarChar(255)
  passwordHash   String?  @map("password_hash") @db.VarChar(255)
  dateOfBirth    DateTime? @map("date_of_birth") @db.Date
  address        String?  @db.Text
  medicalHistory String?  @map("medical_history") @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamp(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  appointments        Appointment[]
  consultations       Consultation[]
  reviews             Review[]
  medicalRecords      MedicalRecord[]
  reminders           Reminder[]
  labOrders           LabOrder[]
  loyaltyPoints       LoyaltyPoints?
  pointsTransactions  PointsTransaction[]

  @@index([email])
  @@index([phone])
  @@index([isActive])
  @@map("patients")
}

// Appointments table
model Appointment {
  id              Int      @id @default(autoincrement())
  patientId       Int?     @map("patient_id")
  doctorId        Int      @map("doctor_id")
  timeSlotId      Int      @map("time_slot_id")
  appointmentDate DateTime @map("appointment_date") @db.Date
  appointmentTime DateTime @map("appointment_time") @db.Time(6)
  status          String   @default("scheduled") @db.VarChar(50) // scheduled, confirmed, completed, cancelled, no_show
  symptoms        String?  @db.Text
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  patient        Patient?        @relation(fields: [patientId], references: [id], onDelete: SetNull)
  doctor         Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  timeSlot       TimeSlot        @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  review         Review?
  medicalRecords MedicalRecord[]
  reminders      Reminder[]
  labOrders      LabOrder[]

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
  @@index([doctorId, appointmentDate])
  @@index([patientId, status])
  @@map("appointments")
}

// Consultations history
model Consultation {
  id                  Int      @id @default(autoincrement())
  patientId           Int?     @map("patient_id")
  symptoms            String   @db.Text
  aiResponse          String?  @map("ai_response") @db.Text
  recommendedSpecialty String? @map("recommended_specialty") @db.VarChar(100)
  severityLevel       String?  @map("severity_level") @db.VarChar(50) // low, medium, high, emergency
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  patient Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  @@index([patientId])
  @@index([severityLevel])
  @@index([createdAt])
  @@map("consultations")
}

// Emergency calls
model EmergencyCall {
  id              Int      @id @default(autoincrement())
  patientName     String?  @map("patient_name") @db.VarChar(255)
  phone           String?  @db.VarChar(20)
  description     String   @db.Text
  location        String?  @db.Text
  status          String   @default("pending") @db.VarChar(50) // pending, dispatched, completed
  priority        String   @default("high") @db.VarChar(50) // low, medium, high, critical
  dispatcherNotes String?  @map("dispatcher_notes") @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("emergency_calls")
}

// Clinic information (FAQ, services, etc.)
model ClinicInfo {
  id           Int      @id @default(autoincrement())
  category     String   @db.VarChar(100) // hours, services, pricing, faq, etc.
  question     String?  @db.Text
  answer       String   @db.Text
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([category])
  @@index([isActive])
  @@map("clinic_info")
}

// Conversation logs
model ConversationLog {
  id         Int      @id @default(autoincrement())
  sessionId  String?  @map("session_id") @db.VarChar(255)
  userInput  String   @map("user_input") @db.Text
  aiResponse String?  @map("ai_response") @db.Text
  intent     String?  @db.VarChar(100) // appointment, consultation, info, emergency
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([sessionId])
  @@index([intent])
  @@index([createdAt])
  @@map("conversation_logs")
}

// Admin users for authentication
model Admin {
  id           Int      @id @default(autoincrement())
  username     String   @unique @db.VarChar(100)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  fullName     String?  @map("full_name") @db.VarChar(255)
  role         String   @default("admin") @db.VarChar(50) // super_admin, admin, doctor, registrar, nurse
  doctorId     Int?     @map("doctor_id") // Link to doctor if role is doctor
  isActive     Boolean  @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamp(6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  auditLogs    AuditLog[]

  @@index([email])
  @@index([username])
  @@index([role])
  @@index([isActive])
  @@index([doctorId])
  @@map("admins")
}

// Audit Log for tracking admin actions
model AuditLog {
  id          Int      @id @default(autoincrement())
  adminId     Int      @map("admin_id")
  action      String   @db.VarChar(100) // create, update, delete, login, logout
  entity      String   @db.VarChar(100) // appointment, doctor, patient, admin, etc.
  entityId    Int?     @map("entity_id") // ID of the affected entity
  details     Json?    // Additional details about the action
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// Doctor Reviews/Ratings
model Review {
  id          Int      @id @default(autoincrement())
  doctorId    Int
  patientId   Int
  appointmentId Int?   @unique
  rating      Int      // 1-5 stars
  comment     String?  @db.Text
  isVerified  Boolean  @default(false) // Verified if patient had appointment
  isApproved  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  doctor      Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient     Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([doctorId])
  @@index([patientId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

// Medical Records (Electronic Health Records)
model MedicalRecord {
  id             Int      @id @default(autoincrement())
  patientId      Int
  doctorId       Int?
  appointmentId  Int?
  recordType     String   // diagnosis, prescription, lab_result, imaging, note
  title          String
  description    String   @db.Text
  diagnosis      String?  @db.Text
  prescription   String?  @db.Text
  labResults     String?  @db.Text
  attachments    String?  @db.Text // JSON array of file URLs
  isConfidential Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  patient        Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor         Doctor?      @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  appointment    Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([patientId])
  @@index([doctorId])
  @@index([recordType])
  @@index([createdAt])
  @@map("medical_records")
}

// Appointment Reminders
model Reminder {
  id            Int      @id @default(autoincrement())
  appointmentId Int
  patientId     Int
  reminderType  String   // email, sms, push
  scheduledFor  DateTime
  sentAt        DateTime?
  status        String   @default("pending") // pending, sent, failed
  message       String   @db.Text
  createdAt     DateTime @default(now())

  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patient       Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([patientId])
  @@index([scheduledFor])
  @@index([status])
  @@map("reminders")
}

// Lab Integration
model LabOrder {
  id            Int       @id @default(autoincrement())
  patientId     Int
  doctorId      Int
  appointmentId Int?
  orderNumber   String    @unique
  labName       String
  testType      String
  status        String    @default("pending") // pending, processing, completed, failed
  orderedAt     DateTime  @default(now())
  completedAt   DateTime?
  results       String?   @db.Text
  resultFileUrl String?
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  patient       Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor        Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([patientId])
  @@index([doctorId])
  @@index([orderNumber])
  @@index([status])
  @@map("lab_orders")
}

// Loyalty Program
model LoyaltyPoints {
  id          Int      @id @default(autoincrement())
  patientId   Int      @unique
  points      Int      @default(0)
  tier        String   @default("bronze") // bronze, silver, gold, platinum
  totalEarned Int      @default(0)
  totalSpent  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([tier])
  @@map("loyalty_points")
}

model PointsTransaction {
  id          Int      @id @default(autoincrement())
  patientId   Int
  amount      Int      // Positive for earned, negative for spent
  type        String   // appointment_completed, referral, reward_redeemed
  description String
  createdAt   DateTime @default(now())

  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([createdAt])
  @@map("points_transactions")
}
