# –ù–æ–≤—ã–µ –§—É–Ω–∫—Ü–∏–∏ MedicalBrothers

## üé• WebRTC –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. **–ó–∞–ø—É—Å–∫ Socket.IO —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏):**
   ```bash
   npm run dev:socket
   ```

2. **–î–æ—Å—Ç—É–ø –∫ –≤–∏–¥–µ–æ–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:**
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ dashboard –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏–º–µ—é—Ç –∫–Ω–æ–ø–∫—É **"üìπ –í–∏–¥–µ–æ–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"**
   - –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–∫—Ä–æ–µ—Ç –≤–∏–¥–µ–æ–∫–æ–º–Ω–∞—Ç—É `/video/{appointmentId}`
   - –ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–ø—Ä–æ—Å—è—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –∑–≤–æ–Ω–∫–∞:**
   - üé§ –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
   - üìπ –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
   - üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫

### –§–∞–π–ª—ã:
- `/components/video/VideoConsultationRoom.tsx` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- `/hooks/useWebRTC.ts` - WebRTC –ª–æ–≥–∏–∫–∞
- `/hooks/useSocket.ts` - Socket.IO –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `/lib/webrtc.ts` - —É—Ç–∏–ª–∏—Ç—ã
- `server.js` - Socket.IO —Å–µ—Ä–≤–µ—Ä

---

## üîî Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è VAPID –∫–ª—é—á–µ–π (–æ–¥–∏–Ω —Ä–∞–∑):**
   ```bash
   npx web-push generate-vapid-keys
   ```
   
   –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–∏ –≤ `.env`:
   ```env
   NEXT_PUBLIC_VAPID_PUBLIC_KEY="YOUR_PUBLIC_KEY"
   VAPID_PRIVATE_KEY="YOUR_PRIVATE_KEY"
   VAPID_SUBJECT="mailto:admin@yourdomain.com"
   ```

2. **–í–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–∞—Ü–∏–µ–Ω—Ç–æ–º:**
   - –ù–∞ dashboard –ø–∞—Ü–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å –±–ª–æ–∫ **"üîî Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"**
   - –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ **"–í–∫–ª—é—á–∏—Ç—å"** –∑–∞–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
   - –ü–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

3. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–∑ –∫–æ–¥–∞):**
   ```typescript
   import { sendPushNotification, NotificationTemplates } from '@/lib/push-notifications';

   // –ü—Ä–∏–º–µ—Ä: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø—Ä–∏—ë–º–µ
   await fetch('/api/push/send', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       userId: '123',
       template: 'appointmentReminder',
       templateData: {
         doctorName: '–î–æ–∫—Ç–æ—Ä –ò–≤–∞–Ω–æ–≤',
         time: '14:00'
       }
     })
   });
   ```

### –§–∞–π–ª—ã:
- `/components/patient/PushNotificationsToggle.tsx` - UI –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
- `/components/PushNotificationManager.tsx` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW
- `/hooks/usePushNotifications.ts` - —Ö—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `/lib/push-notifications.ts` - —É—Ç–∏–ª–∏—Ç—ã –∏ —à–∞–±–ª–æ–Ω—ã
- `/app/api/push/subscribe/route.ts` - –ø–æ–¥–ø–∏—Å–∫–∞
- `/app/api/push/send/route.ts` - –æ—Ç–ø—Ä–∞–≤–∫–∞
- `/public/sw.js` - Service Worker

### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
- üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–∏—ë–º–∞—Ö
- üí¨ –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- üìπ –í–∏–¥–µ–æ–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã
- üíä –†–µ—Ü–µ–ø—Ç—ã –≥–æ—Ç–æ–≤—ã

---

## üí≥ –ü–ª–∞—Ç—ë–∂–Ω–∞—è –°–∏—Å—Ç–µ–º–∞

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Stripe (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏):**
   ```env
   STRIPE_SECRET_KEY="sk_test_..."
   STRIPE_PUBLISHABLE_KEY="pk_test_..."
   STRIPE_WEBHOOK_SECRET="whsec_..."
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
   ```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ YooKassa (–¥–ª—è –†–§):**
   ```env
   YOOKASSA_SHOP_ID="your_shop_id"
   YOOKASSA_SECRET_KEY="your_secret_key"
   ```

3. **–û–ø–ª–∞—Ç–∞ –Ω–∞ UI:**
   - –ù–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–ø–∏—Å–∏ (`AppointmentCard`) –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ **"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å 1500 ‚ÇΩ"**
   - –ö–ª–∏–∫ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (Stripe/YooKassa)
   - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—ë—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ

4. **Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (Stripe):**
   - Stripe Dashboard ‚Üí Developers ‚Üí Webhooks
   - Add endpoint: `https://your-domain.com/api/payment/webhook`
   - –°–æ–±—ã—Ç–∏—è: `payment_intent.succeeded`, `payment_intent.payment_failed`

### –§–∞–π–ª—ã:
- `/components/patient/PaymentButton.tsx` - –∫–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã
- `/lib/payments.ts` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è Stripe –∏ YooKassa
- `/app/api/payment/create/route.ts` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- `/app/api/payment/status/route.ts` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- `/app/api/payment/webhook/route.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π Stripe

### API –ü—Ä–∏–º–µ—Ä—ã:

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**
```bash
curl -X POST http://localhost:3000/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "yookassa",
    "appointmentId": 1,
    "amount": 1500,
    "currency": "rub"
  }'
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
```bash
curl "http://localhost:3000/api/payment/status?provider=stripe&paymentId=pi_xxx"
```

---

## üóÇ –û–±–∑–æ—Ä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### Dashboard –ü–∞—Ü–∏–µ–Ω—Ç–∞ (`/patient/dashboard`):
‚úÖ **Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –±–ª–æ–∫ "üîî Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
‚úÖ **–û–ø–ª–∞—Ç–∞ –∑–∞–ø–∏—Å–µ–π** - –∫–Ω–æ–ø–∫–∞ "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å" –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∑–∞–ø–∏—Å–µ–π
‚úÖ **–í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏** - –∫–Ω–æ–ø–∫–∞ "üìπ –í–∏–¥–µ–æ–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

### –ù–æ–≤—ã–µ –°—Ç—Ä–∞–Ω–∏—Ü—ã:
- `/video/[roomId]` - –í–∏–¥–µ–æ–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è

### –ù–æ–≤—ã–µ API Endpoints:
- `/api/push/subscribe` - –ü–æ–¥–ø–∏—Å–∫–∞/–æ—Ç–ø–∏—Å–∫–∞ –æ—Ç push
- `/api/push/send` - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `/api/payment/create` - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- `/api/payment/status` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
- `/api/payment/webhook` - Webhook –¥–ª—è Stripe

---

## üöÄ –õ–æ–∫–∞–ª—å–Ω—ã–π –ó–∞–ø—É—Å–∫

```bash
# Terminal 1: Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
npm run dev

# Terminal 2: Socket.IO —Å–µ—Ä–≤–µ—Ä –¥–ª—è WebRTC
npm run dev:socket
```

–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000

---

## üìñ –î–µ–ø–ª–æ–π –Ω–∞ Production

–°–º. —Ñ–∞–π–ª **`DEPLOYMENT.md`** –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –¥–µ–ø–ª–æ—é –Ω–∞ Vercel —Å managed –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:
- PostgreSQL/Redis —á–µ—Ä–µ–∑ Docker –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ Vercel
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Vercel Postgres –∏–ª–∏ Supabase
- Socket.IO —Å–µ—Ä–≤–µ—Ä –¥–µ–ø–ª–æ–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ Railway/Render
- –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ VAPID –∫–ª—é—á–∏ –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhooks –¥–ª—è Stripe

---

## üêõ Troubleshooting

**Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ VAPID –∫–ª—é—á–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ `.env`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: DevTools ‚Üí Application ‚Üí Service Workers
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: DevTools ‚Üí Application ‚Üí Storage ‚Üí Notifications

**WebRTC –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Socket.IO —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (`npm run dev:socket`)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
3. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É

**–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á–∏ –≤ `.env`
2. –î–ª—è Stripe: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã (4242 4242 4242 4242)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

---

**–í—Å–µ —Ñ–∞–π–ª—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ**
